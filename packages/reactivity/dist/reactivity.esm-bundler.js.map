{"version":3,"file":"reactivity.esm-bundler.js","sources":["../src/effect.js","../../shared/src/index.js","../src/baseHandler.js","../src/reactive.js"],"sourcesContent":["let reactivrEffectStack = []\nlet currentReactiveEffect = undefined\n\nfunction createReactiveEffect (fn, scheduler) {\n  const reactiveEffect = function () {\n    if (!reactivrEffectStack.includes(reactiveEffect)) {\n      try {\n        reactivrEffectStack.push(reactiveEffect)\n        currentReactiveEffect = reactiveEffect\n        fn()\n      } finally {\n        reactivrEffectStack.pop()\n        currentReactiveEffect = reactivrEffectStack[reactivrEffectStack.length - 1]\n      }\n    }\n  }\n  reactiveEffect.scheduler = scheduler\n  return reactiveEffect\n}\n\nfunction effect (fn, option = { lazy: false, scheduler: undefined }) {\n  const reactiveEffect = createReactiveEffect(fn, option.scheduler)\n  if (option.lazy !== true) {\n    reactiveEffect()\n  }\n}\n\nconst targetMap = new WeakMap()\n\nfunction Track (target, key) {\n  if (!currentReactiveEffect) {\n    return\n  }\n  let depMap = targetMap.get(target)\n  if (!depMap) {\n    targetMap.set(target, (depMap = new Map))\n  }\n  let dep = depMap.get(key)\n  if (!dep) {\n    depMap.set(key, (dep = new Set))\n  }\n  if (!dep.has(currentReactiveEffect)) {\n    dep.add(currentReactiveEffect)\n  }\n}\n\nfunction Trigger (target, key) {\n  let depMap = targetMap.get(target)\n  if (!depMap) {\n    return\n  }\n  const effectSet = new Set()\n  depMap.get(key).forEach(effect => {\n    effectSet.add(effect)\n  })\n  effectSet.forEach(effect => {\n    if (effect.scheduler) {\n      effect.scheduler()\n    } else {\n      effect()\n    }\n  })\n}\n\nexport {\n  effect,\n  Trigger,\n  Track\n}","function isObject(param) {\n    return Object.prototype.toString.call(param) === '[object Object]'\n}\n\nexport {\n    isObject\n}","import { isObject } from '../../shared/src/index.js'\nimport { Track, Trigger } from './effect'\nimport { isReactive, reactive, readonly } from './reactive'\n\nfunction getCreator (isShallow = false, isReadOnly = false) {\n  return (target, key) => {\n    if (key === 'is_reactive') {\n      return !isReadOnly\n    }\n    if (key === 'is_readonly') {\n      return isReadOnly\n    }\n    let res = Reflect.get(target, key)\n    if (!isReadOnly) {\n      //TODO 收集\n      Track(target, key)\n    }\n    if (!isShallow && isObject(res)) {\n      //TODO 将res转变成响应式对象\n      return isReadOnly ? readonly(res) : reactive(res)\n    } else {\n      return res\n    }\n  }\n}\n\nfunction setCreator (isReadOnly = false) {\n  return (target, key, val) => {\n    if (isReadOnly) {\n      throw new Error('这是一个只读的对象')\n    }\n    Reflect.set(target, key, val)\n    //TODO 触发依赖\n    Trigger(target, key)\n  }\n}\n\nconst reactiveHandler = {\n  get: getCreator(),\n  set: setCreator()\n}\nconst shallowHandler = {\n  get: getCreator(true),\n  set: setCreator()\n}\nconst readOnlyHandler = {\n  get: getCreator(false, true),\n  set: setCreator(true)\n}\nconst shallowReadOnlyHandler = {\n  get: getCreator(true, true),\n  set: setCreator(true)\n}\nexport {\n  reactiveHandler,\n  shallowHandler,\n  readOnlyHandler,\n  shallowReadOnlyHandler\n}","import {\n  reactiveHandler,\n  readOnlyHandler,\n  shallowHandler,\n  shallowReadOnlyHandler\n} from './baseHandler.js'\nimport { isObject } from '../../shared/src'\n\n// TODO 为什么要设计两个Map来存储呢?\nconst reactiveMap = new WeakMap()\nconst readOnlyMap = new WeakMap()\n\nfunction createReactiveObject (target, isReadOnly, handler) {\n  if (isObject(target) !== true) {\n    throw new Error('只能将对象转化为响应式对象')\n  }\n  const proxyMap = isReadOnly ? readOnlyMap : reactiveMap\n  let proxy = proxyMap.get(target)\n  if (proxy) {\n    return proxy\n  } else {\n    proxy = new Proxy(target, handler)\n    proxyMap.set(target, proxy)\n    return proxy\n  }\n}\n\nfunction reactive (target) {\n  return createReactiveObject(target, false, reactiveHandler)\n}\n\nfunction readonly (target) {\n  return createReactiveObject(target, true, readOnlyHandler)\n}\n\nfunction shallowReactive (target) {\n  return createReactiveObject(target, false, shallowHandler)\n}\n\nfunction shallowReadonly (target) {\n  return createReactiveObject(target, true, shallowReadOnlyHandler)\n}\n\nfunction isReactive (target) {\n  return !!target['is_reactive']\n}\n\nfunction isReadOnly (target) {\n  return !!target['is_readonly']\n}\n\nfunction isProxy (target) {\n  return isReactive(target) || isReadOnly(target)\n}\n\nexport {\n  reactive,\n  readonly,\n  shallowReactive,\n  shallowReadonly,\n  isReactive,\n  isReadOnly,\n  isProxy\n}"],"names":[],"mappings":"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"}