{"version":3,"file":"reactivity.global.js","sources":["../src/effect.js","../../shared/src/index.js","../src/baseHandler.js","../src/reactive.js","../src/ref.js"],"sourcesContent":["let reactiveEffectStack = []\nlet currentReactiveEffect = undefined\n\nfunction createReactiveEffect (fn, scheduler) {\n  const reactiveEffect = function () {\n    if (!reactiveEffectStack.includes(reactiveEffect)) {\n      try {\n        reactiveEffectStack.push(reactiveEffect)\n        currentReactiveEffect = reactiveEffect\n        fn()\n      } finally {\n        reactiveEffectStack.pop()\n        currentReactiveEffect = reactiveEffectStack[reactiveEffectStack.length - 1]\n      }\n    }\n  }\n  reactiveEffect.scheduler = scheduler\n  return reactiveEffect\n}\n\nfunction effect (fn, option = { lazy: false, scheduler: undefined }) {\n  const reactiveEffect = createReactiveEffect(fn, option.scheduler)\n  if (option.lazy !== true) {\n    reactiveEffect()\n  }\n}\n\nconst targetMap = new WeakMap()\n\nfunction Track (target, key) {\n  if (!currentReactiveEffect) {\n    return\n  }\n  let depMap = targetMap.get(target)\n  if (!depMap) {\n    targetMap.set(target, (depMap = new Map))\n  }\n  let dep = depMap.get(key)\n  if (!dep) {\n    depMap.set(key, (dep = new Set))\n  }\n  if (!dep.has(currentReactiveEffect)) {\n    dep.add(currentReactiveEffect)\n  }\n}\n\nfunction Trigger (target, key) {\n  let depMap = targetMap.get(target)\n  if (!depMap) {\n    return\n  }\n  const effectSet = new Set()\n  depMap.get(key).forEach(effect => {\n    effectSet.add(effect)\n  })\n  effectSet.forEach(effect => {\n    if (effect.scheduler) {\n      effect.scheduler()\n    } else {\n      effect()\n    }\n  })\n}\n\nexport {\n  effect,\n  Trigger,\n  Track,\n  targetMap\n}","function isObject (param) {\n  return Object.prototype.toString.call(param) === '[object Object]'\n}\n\nfunction isString (param) {\n  return Object.prototype.toString.call(param) === '[object String]'\n}\n\nfunction isBoolean (param) {\n  return Object.prototype.toString.call(param) === '[object Boolean]'\n}\n\nfunction isNull (param) {\n  return Object.prototype.toString.call(param) === '[object Null]'\n}\n\nfunction isUndefined (param) {\n  return Object.prototype.toString.call(param) === '[object Undefined]'\n}\n\nfunction isArray (param) {\n  return Object.prototype.toString.call(param) === '[object Array]'\n}\n\nfunction isFunction (param) {\n  return Object.prototype.toString.call(param) === '[object Function]'\n}\n\nfunction isDate (param) {\n  return Object.prototype.toString.call(param) === '[object Date]'\n}\n\nfunction isRegExp (param) {\n  return Object.prototype.toString.call(param) === '[object RegExp]'\n}\n\nfunction hasChanged (param1, param2) {\n  return param1 !== param2\n}\n\nfunction hasOwnProperty (obj, key) {\n  return Object.prototype.hasOwnProperty.call(obj, key)\n}\n\nfunction isOn (key) {\n  return /^on[A-Za-z]+/.test(key)\n}\n\nconst extend = Object.assign\nexport {\n  isObject,\n  isArray,\n  isString,\n  isBoolean,\n  isDate,\n  isFunction,\n  isNull,\n  isUndefined,\n  isRegExp,\n  hasChanged,\n  hasOwnProperty,\n  isOn,\n  extend\n}\nexport {\n  ShapeFlags\n} from './flags'","import { isObject } from '../../shared/src/index.js'\nimport { Track, Trigger } from './effect'\nimport { isReactive, reactive, readonly } from './reactive'\n\nfunction getCreator (isShallow = false, isReadOnly = false) {\n  return (target, key) => {\n    if (key === 'is_reactive') {\n      return !isReadOnly\n    }\n    if (key === 'is_readonly') {\n      return isReadOnly\n    }\n    let res = Reflect.get(target, key)\n    if (!isReadOnly) {\n      //TODO 收集\n      Track(target, key)\n    }\n    if (!isShallow && isObject(res)) {\n      //TODO 将res转变成响应式对象\n      return isReadOnly ? readonly(res) : reactive(res)\n    } else {\n      return res\n    }\n  }\n}\n\nfunction setCreator (isReadOnly = false) {\n  return (target, key, val) => {\n    if (isReadOnly) {\n      throw new Error('这是一个只读的对象')\n    }\n    Reflect.set(target, key, val)\n    //TODO 触发依赖\n    Trigger(target, key)\n  }\n}\n\nconst reactiveHandler = {\n  get: getCreator(),\n  set: setCreator()\n}\nconst shallowHandler = {\n  get: getCreator(true),\n  set: setCreator()\n}\nconst readOnlyHandler = {\n  get: getCreator(false, true),\n  set: setCreator(true)\n}\nconst shallowReadOnlyHandler = {\n  get: getCreator(true, true),\n  set: setCreator(true)\n}\nexport {\n  reactiveHandler,\n  shallowHandler,\n  readOnlyHandler,\n  shallowReadOnlyHandler\n}","import {\n  reactiveHandler,\n  readOnlyHandler,\n  shallowHandler,\n  shallowReadOnlyHandler\n} from './baseHandler.js'\nimport { isObject } from '../../shared/src'\n\n// TODO 为什么要设计两个Map来存储呢?\nconst reactiveMap = new WeakMap()\nconst readOnlyMap = new WeakMap()\n\nfunction createReactiveObject (target, isReadOnly, handler) {\n  if (isObject(target) !== true) {\n    throw new Error('只能将对象转化为响应式对象')\n  }\n  const proxyMap = isReadOnly ? readOnlyMap : reactiveMap\n  let proxy = proxyMap.get(target)\n  if (proxy) {\n    return proxy\n  } else {\n    proxy = new Proxy(target, handler)\n    proxyMap.set(target, proxy)\n    return proxy\n  }\n}\n\nfunction reactive (target) {\n  return createReactiveObject(target, false, reactiveHandler)\n}\n\nfunction readonly (target) {\n  return createReactiveObject(target, true, readOnlyHandler)\n}\n\nfunction shallowReactive (target) {\n  return createReactiveObject(target, false, shallowHandler)\n}\n\nfunction shallowReadonly (target) {\n  return createReactiveObject(target, true, shallowReadOnlyHandler)\n}\n\nfunction isReactive (target) {\n  return !!target['is_reactive']\n}\n\nfunction isReadOnly (target) {\n  return !!target['is_readonly']\n}\n\nfunction isProxy (target) {\n  return isReactive(target) || isReadOnly(target)\n}\n\nexport {\n  reactive,\n  readonly,\n  shallowReactive,\n  shallowReadonly,\n  isReactive,\n  isReadOnly,\n  isProxy\n}","import { Track, Trigger } from './effect'\n\nclass RefImpl {\n  constructor (value) {\n    this._value = value\n  }\n\n  get value () {\n    Track(this, 'value')\n    return this._value\n  }\n\n  set value (newValue) {\n    this._value = newValue\n    Trigger(this, 'value')\n  }\n}\n\nfunction ref (target) {\n  return new RefImpl(target)\n}\n\nexport {\n  ref\n}\n"],"names":[],"mappings":"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"}